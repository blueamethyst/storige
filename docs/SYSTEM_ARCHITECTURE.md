# Storige 시스템 아키텍처

> 작성일: 2024-12-11
> 버전: 1.1 (bookmoa 상세 추가: 2024-12-13)

---

## 1. 시스템 개요

Storige는 인쇄 쇼핑몰을 위한 온라인 편집 시스템으로, 다음 구성요소로 이루어져 있습니다:

| 구성요소 | 기술 스택 | 역할 |
|---------|----------|------|
| 쇼핑몰 (북모아) | PHP + Nexmotion + ADODB | 고객 주문, 결제, 회원 관리, 12단계 주문 상태 |
| 관리자 (북모아) | PHP + Nexmotion | 주문처리, 생산관리, PDF 조판 (Cypress) |
| 관리자 (Storige) | React + Ant Design | 템플릿/상품/주문 관리 |
| 에디터 (번들) | React + Fabric.js | 쇼핑몰 임베딩용 편집기 |
| 에디터 (Standalone) | React + Fabric.js | 관리자용 편집기 |
| API 서버 | NestJS | REST API, 인증, 비즈니스 로직 |
| Worker | NestJS + Bull | PDF 검증/변환/합성 |
| DB (Storige) | MariaDB | 템플릿, 편집세션, 워커잡 |
| DB (쇼핑몰) | MariaDB (gprinting) | 회원, 주문, 상품, 정산 |

---

## 2. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    클라이언트 영역                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐       │
│  │                     │     │                     │     │                     │       │
│  │   쇼핑몰 (PHP)       │     │   관리자 (React)     │     │  관리자 에디터       │       │
│  │   북모아            │     │   Admin Dashboard   │     │  (Standalone)       │       │
│  │                     │     │                     │     │                     │       │
│  │  ┌───────────────┐  │     │  - 템플릿 관리       │     │  - 템플릿 편집       │       │
│  │  │ 에디터 (번들)  │  │     │  - 상품 관리        │     │  - 미리보기         │       │
│  │  │ JS Embed      │  │     │  - 주문 관리        │     │  - 테스트           │       │
│  │  └───────────────┘  │     │  - 워커잡 모니터링   │     │                     │       │
│  │                     │     │                     │     │                     │       │
│  │  - 회원 가입/로그인  │     └─────────────────────┘     └─────────────────────┘       │
│  │  - 상품 주문        │              │                           │                    │
│  │  - 파일 업로드      │              │                           │                    │
│  │  - 결제            │              │                           │                    │
│  └─────────────────────┘              │                           │                    │
│           │                          │                           │                    │
│           │ httpOnly Cookie          │ JWT (Bearer)              │ JWT (Bearer)       │
│           │ (세션 토큰)               │                           │                    │
│           │                          │                           │                    │
└───────────┼──────────────────────────┼───────────────────────────┼────────────────────┘
            │                          │                           │
            ▼                          ▼                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    서버 영역                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                            Storige API (NestJS)                                  │   │
│  │                               :4000                                              │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │   │
│  │  │    Auth      │  │   Editor     │  │  Templates   │  │  Worker Jobs │        │   │
│  │  │   Module     │  │   Module     │  │   Module     │  │    Module    │        │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤  ├──────────────┤        │   │
│  │  │ - 로그인     │  │ - 세션 관리  │  │ - 템플릿셋   │  │ - 검증 요청  │        │   │
│  │  │ - 세션 토큰  │  │ - 캔버스저장 │  │ - 카테고리   │  │ - 변환 요청  │        │   │
│  │  │ - 토큰 갱신  │  │ - PDF 생성   │  │ - 규격 관리  │  │ - 상태 조회  │        │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │   │
│  │                                                                                  │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                          │   │
│  │  │   Products   │  │    Files     │  │   Storage    │                          │   │
│  │  │   Module     │  │   Module     │  │   Module     │                          │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤                          │   │
│  │  │ - 상품 조회  │  │ - 파일업로드 │  │ - 파일 저장  │                          │   │
│  │  │ - 세네카계산 │  │ - 썸네일     │  │ - 경로 관리  │                          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                          │   │
│  │                                                                                  │   │
│  └──────────────────────────────────────────┬──────────────────────────────────────┘   │
│                                             │                                          │
│                                             │ Bull Queue                               │
│                                             │                                          │
│  ┌──────────────────────────────────────────▼──────────────────────────────────────┐   │
│  │                            Worker (NestJS)                                       │   │
│  │                               :4001                                              │   │
│  ├─────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                  │   │
│  │  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐        │   │
│  │  │  Validation        │  │   Conversion       │  │   Synthesis        │        │   │
│  │  │  Processor         │  │   Processor        │  │   Processor        │        │   │
│  │  ├────────────────────┤  ├────────────────────┤  ├────────────────────┤        │   │
│  │  │ - 사이즈 검증      │  │ - 빈페이지 추가    │  │ - 표지+내지 병합   │        │   │
│  │  │ - 페이지수 검증    │  │ - 재단선 추가      │  │ - 최종 PDF 생성    │        │   │
│  │  │ - 재단선 검증      │  │ - 세네카 조정      │  │                    │        │   │
│  │  │ - 해상도 검사      │  │                    │  │                    │        │   │
│  │  └────────────────────┘  └────────────────────┘  └────────────────────┘        │   │
│  │                                                                                  │   │
│  │  Tools: pdf-lib, Sharp, Ghostscript                                             │   │
│  │                                                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
            │                                             │
            │                                             │
            ▼                                             ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    데이터 영역                                           │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────┐         ┌─────────────────────────────┐               │
│  │      Storige DB             │         │      쇼핑몰 DB               │               │
│  │      (MariaDB)              │         │      (MariaDB)              │               │
│  ├─────────────────────────────┤         ├─────────────────────────────┤               │
│  │                             │         │                             │               │
│  │  users (관리자)             │         │  members (회원)             │               │
│  │  templates                  │◄───────►│  orders (주문)              │               │
│  │  template_sets              │  향후   │  products (상품)            │               │
│  │  edit_sessions              │  통합   │  payments (결제)            │               │
│  │  worker_jobs                │         │                             │               │
│  │  files                      │         │                             │               │
│  │                             │         │                             │               │
│  └─────────────────────────────┘         └─────────────────────────────┘               │
│                                                                                         │
│  ┌─────────────────────────────┐         ┌─────────────────────────────┐               │
│  │      Redis                  │         │      Storage                │               │
│  │      (Queue/Cache)          │         │      (File System)          │               │
│  ├─────────────────────────────┤         ├─────────────────────────────┤               │
│  │                             │         │                             │               │
│  │  pdf-validation (Queue)     │         │  /uploads                   │               │
│  │  pdf-conversion (Queue)     │         │  /templates                 │               │
│  │  pdf-synthesis (Queue)      │         │  /outputs                   │               │
│  │  session-cache              │         │  /thumbnails                │               │
│  │                             │         │                             │               │
│  └─────────────────────────────┘         └─────────────────────────────┘               │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 컴포넌트별 상세 설명

### 3.1 쇼핑몰 (PHP - 북모아)

**역할:** 고객 대면 서비스 (B2C), 주문/결제 처리

#### 3.1.1 기술 스택

| 항목 | 기술 |
|------|------|
| 프레임워크 | Nexmotion (커스텀 PHP 프레임워크) |
| DB 라이브러리 | ADODB (Active Record 패턴) |
| 설계 패턴 | DAO, State, Factory |
| 세션 | PHP SESSION + FormBean |
| 다중 사이트 | `$_SERVER["SELL_SITE"]` (GP, DP 등) |

#### 3.1.2 디렉토리 구조

```
bookmoa/
├── front/                        # B2C 고객 포털
│   ├── ajax/                     # AJAX 핸들러 (JSON 응답)
│   │   ├── common/               # 회원정보, 배송주소
│   │   ├── order/                # 배송비, 쿠폰, 상품정보
│   │   ├── product/              # 가격계산, 옵션 로드
│   │   └── mypage/               # 주문조회, 배송추적
│   ├── proc/                     # 비즈니스 로직 (주문, 결제, 파일업로드)
│   ├── common/
│   │   └── sess_common.php       # ★ 세션 초기화 (모든 페이지 include)
│   ├── main/, product/           # 페이지 템플릿
│   ├── order/, mypage/           # 주문 흐름, 마이페이지
│   └── webpay_*/                 # PG 결제 모듈
│
├── nimda/                        # B2B 관리자 포털 (admin 역순)
│   ├── ajax/                     # 관리자 AJAX
│   ├── proc/                     # 관리자 비즈니스 로직
│   ├── cypress/                  # ★ PDF 조판 엔진
│   │   ├── process/              # 조판 클래스 (OrderInfo, PlateFileEnzine)
│   │   ├── ghostscript-9.22/     # PDF 처리 바이너리
│   │   └── KORKIT/               # 한글 조판 라이브러리
│   ├── engine/                   # 가격계산 엔진 (proc_engine, util_engine)
│   ├── application/              # 고급 앱 (delivery, statemanager, labelmanager)
│   ├── order/, member/           # 주문/회원 관리
│   └── manufacture/              # 생산 관리
│
└── inc/                          # 공통 라이브러리
    ├── com/nexmotion/
    │   ├── common/util/
    │   │   └── ConnectionPool.inc    # DB 연결 풀
    │   ├── common/entity/
    │   │   └── FormBean.inc          # 요청/세션 처리
    │   └── job/{front,nimda}/        # DAO 레이어 (모듈별)
    ├── classes/dprinting/
    │   ├── StateManager/             # ★ 12단계 주문 상태 (State 패턴)
    │   └── PriceCalculator/          # ★ 상품별 가격계산 (30개 상품 클래스)
    ├── common_dao/
    │   └── CommonDAO.inc             # 기본 DAO (쿼리빌더, SQL 인젝션 방지)
    ├── common_lib/
    │   └── CalcPriceUtil.inc         # 가격계산 핵심 로직
    └── common_define/
        ├── order_status.inc          # 주문 상태 코드 정의
        └── common_config.inc         # 파일경로, 상수
```

#### 3.1.3 핵심 컴포넌트

**FormBean** - 요청/세션 통합 처리:
```php
$fb = new FormBean();
$fb->form("key");           // GET/POST 파라미터
$fb->session("key");        // SESSION 값
$fb->addSession("key", $val);  // SESSION 저장
$fb->removeAllSession();    // 로그아웃
```

**ConnectionPool** - DB 연결:
```php
$connectionPool = new ConnectionPool();
$conn = $connectionPool->getPooledConnection();
// ... ADODB 쿼리 실행
$conn->Close();
```

**DAO 패턴**:
```
CommonDAO (기본) → ProductCommonDAO → 구체적 DAO (OrderDAO, MemberDAO, ...)
```
- `parameterEscape($conn, $param)` - SQL 인젝션 방지
- `arr2paramStr($conn, $arr)` - 배열 → IN 절 변환

#### 3.1.4 주문 상태 흐름 (12단계)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              주문 상태 흐름                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  주문(110)    입금(210)    접수(310-340)    조판(410-430)    종이발주(510-530)   │
│     │           │             │               │                  │             │
│     ▼           ▼             ▼               ▼                  ▼             │
│  ┌─────┐    ┌─────┐       ┌─────┐         ┌─────┐           ┌─────┐           │
│  │대기 │───►│대기 │──────►│대기 │────────►│대기 │──────────►│대기 │           │
│  │     │    │     │       │중   │         │중   │           │완료 │           │
│  │취소 │    │     │       │교정 │         │누락 │           │취소 │           │
│  └─────┘    └─────┘       │보류 │         └─────┘           └─────┘           │
│                           └─────┘                                              │
│                                                                                 │
│  출력(605-630)    인쇄(705-730)    후공정(805-830)    입고(910-920)             │
│       │               │                │                  │                    │
│       ▼               ▼                ▼                  ▼                    │
│   ┌─────┐         ┌─────┐          ┌─────┐           ┌─────┐                  │
│   │준비 │────────►│준비 │─────────►│준비 │──────────►│대기 │                  │
│   │대기 │         │대기 │          │대기 │           │중   │                  │
│   │중   │         │중   │          │중   │           └─────┘                  │
│   │취소 │         │취소 │          │취소 │               │                    │
│   └─────┘         └─────┘          └─────┘               ▼                    │
│                                                      ┌─────┐                  │
│  출고(950-960)    배송(010-011)    구매확정(020-021)  │     │                  │
│       │               │                │             └─────┘                  │
│       ▼               ▼                ▼                                      │
│   ┌─────┐         ┌─────┐          ┌─────┐                                   │
│   │대기 │────────►│대기 │─────────►│대기 │                                   │
│   │중   │         │중   │          │완료 │                                   │
│   └─────┘         └─────┘          └─────┘                                   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**StateManager 패턴** (`inc/classes/dprinting/StateManager/`):
- `StateManager.php` - 상태 관리 메인 클래스
- `StateFactory.php` - 상태 객체 생성 팩토리
- `concretes/` - 20개 상태 클래스 (PrintingState, PressingState, OutputingState, ...)

#### 3.1.5 가격계산 엔진

**PriceCalculator** (`inc/classes/dprinting/PriceCalculator/`):
```
Products/
├── Product.php          # 추상 기본 클래스
├── CommonProduct.php    # 공통상품
├── Booklet.php          # 책자
├── Catalog.php          # 카탈로그
├── Namecard.php         # 명함
├── Banner.php           # 배너
├── Poster.php           # 포스터
└── ... (총 30개 상품)
```

**CalcPriceUtil** (`inc/common_lib/CalcPriceUtil.inc`):
- 수량, 재질, 페이지수, 옵션에 따른 동적 가격 계산
- `calcPaperPrice()` - 종이비
- `calcPrintPrice()` - 인쇄비
- `calcOutputPrice()` - 규격비
- `calcTotalPrice()` - 최종 가격

#### 3.1.6 Storige 연동 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                     쇼핑몰 (PHP)                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [회원 관리]        [상품/주문]        [에디터 연동]             │
│  - 로그인/회원가입   - 상품 목록        - 세션 토큰 발급         │
│  - 세션 관리        - 장바구니         - 에디터 JS 로드          │
│  - 마이페이지       - 주문/결제        - 콜백 처리              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                에디터 JS 번들 (임베딩)                    │   │
│  │                                                         │   │
│  │  <div id="editor-root"></div>                           │   │
│  │  <script src="/editor-bundle.js"></script>              │   │
│  │                                                         │   │
│  │  - React + Fabric.js                                    │   │
│  │  - httpOnly Cookie로 API 인증                           │   │
│  │  - 표지/내지 편집                                        │   │
│  │  - 완료 시 onComplete 콜백                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
          │
          │ API 호출 (X-API-Key)
          │
          ▼
    ┌─────────────┐
    │ Storige API │
    └─────────────┘
```

**인증 방식:**
- 쇼핑몰 PHP → Storige API: `X-API-Key` (서버 간)
- 에디터 JS 번들 → Storige API: `httpOnly Cookie` (클라이언트)
- 북모아 내부 세션: PHP SESSION + FormBean

### 3.2 관리자 (Admin Dashboard)

**역할:** 템플릿, 상품, 주문, 워커잡 관리

```
┌─────────────────────────────────────────────────────────────────┐
│                     관리자 (React)                               │
│                     :3001                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [템플릿 관리]       [상품 관리]        [주문/워커 관리]          │
│  - 템플릿셋 CRUD    - 상품 목록        - 주문 목록               │
│  - 카테고리 관리    - 규격 설정        - 워커잡 모니터링          │
│  - 에디터로 편집    - 가격 설정        - 실패 잡 재시도           │
│                                                                 │
│  인증: JWT Bearer Token (localStorage)                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
          │
          │ REST API (Bearer Token)
          │
          ▼
    ┌─────────────┐
    │ Storige API │
    └─────────────┘
```

### 3.3 에디터 (Standalone)

**역할:** 관리자가 템플릿 편집 시 사용하는 전체 에디터

```
┌─────────────────────────────────────────────────────────────────┐
│                     에디터 Standalone                            │
│                     :3000                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [캔버스 편집]       [레이어 관리]      [에셋 라이브러리]         │
│  - Fabric.js 기반   - 오브젝트 정렬    - 이미지 업로드            │
│  - 텍스트/이미지    - z-index 조정    - 클립아트                 │
│  - 도형/배경        - 그룹화          - 배경 템플릿              │
│                                                                 │
│  [플러그인 시스템]                                               │
│  - TextPlugin                                                   │
│  - ImagePlugin                                                  │
│  - ShapePlugin                                                  │
│  - SelectionPlugin                                              │
│  - HistoryPlugin (Undo/Redo)                                    │
│                                                                 │
│  인증: JWT Bearer Token (관리자와 동일)                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
          │
          │ REST API (Bearer Token)
          │
          ▼
    ┌─────────────┐
    │ Storige API │
    └─────────────┘
```

### 3.4 에디터 (JS 번들)

**역할:** 쇼핑몰에 임베딩되는 경량화된 에디터

```
┌─────────────────────────────────────────────────────────────────┐
│                     에디터 JS 번들                               │
│                     editor-bundle.js (IIFE)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  window.StorigeEditor = {                                       │
│    create(config) → EditorInstance,                             │
│    version: '1.0.0'                                             │
│  }                                                              │
│                                                                 │
│  EditorInstance:                                                │
│  - mount(elementId)      // DOM에 마운트                         │
│  - unmount()             // 언마운트                             │
│  - save()                // 임시 저장                            │
│  - complete()            // 편집 완료                            │
│  - cancel()              // 취소                                 │
│                                                                 │
│  특징:                                                          │
│  - Standalone 에디터의 서브셋                                    │
│  - 쇼핑몰 DOM에 직접 렌더링                                      │
│  - httpOnly Cookie 인증 (credentials: 'include')                │
│  - 콜백 기반 통신 (onComplete, onError)                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Standalone vs 번들 비교:**

| 항목 | Standalone | JS 번들 |
|------|-----------|--------|
| 용도 | 관리자 템플릿 편집 | 쇼핑몰 고객 편집 |
| 배포 | 별도 서버 (:3000) | 쇼핑몰 페이지 임베딩 |
| 인증 | JWT Bearer | httpOnly Cookie |
| 기능 | 전체 기능 | 제한된 기능 |
| 빌드 | SPA (Vite) | IIFE 번들 |

---

## 4. 인증 및 데이터 흐름

### 4.1 인증 방식 요약

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           인증 방식                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [쇼핑몰 PHP → API]                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Header: X-API-Key: {shop-api-key}                               │   │
│  │ 용도: 파일 업로드, 워커잡 생성, 세션 토큰 발급                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [에디터 번들 → API]                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Cookie: storige_access={JWT}; storige_refresh={JWT}             │   │
│  │ 용도: 편집 세션 저장/조회, 에셋 조회                              │   │
│  │ 특징: httpOnly, Secure, SameSite=Lax                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [관리자/에디터 Standalone → API]                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Header: Authorization: Bearer {JWT}                             │   │
│  │ 용도: 템플릿 관리, 상품 관리, 전체 기능                           │   │
│  │ 저장: localStorage                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 고객 주문 흐름

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│  쇼핑몰   │      │  API     │      │  에디터   │      │  Worker  │      │   DB     │
│  (PHP)   │      │ (NestJS) │      │  (번들)   │      │ (NestJS) │      │(MariaDB) │
└────┬─────┘      └────┬─────┘      └────┬─────┘      └────┬─────┘      └────┬─────┘
     │                 │                 │                 │                 │
     │ 1. 로그인       │                 │                 │                 │
     │─────────────────┼─────────────────┼─────────────────┼────────────────►│
     │                 │                 │                 │                 │
     │ 2. 상품 선택    │                 │                 │                 │
     │ 3. 에디터 열기  │                 │                 │                 │
     │                 │                 │                 │                 │
     │ 4. 세션 토큰 요청                 │                 │                 │
     │────────────────►│                 │                 │                 │
     │◄────────────────│ Set-Cookie      │                 │                 │
     │                 │                 │                 │                 │
     │ 5. 에디터 번들 로드               │                 │                 │
     │─────────────────┼────────────────►│                 │                 │
     │                 │                 │                 │                 │
     │                 │ 6. 세션 생성    │                 │                 │
     │                 │◄────────────────│                 │                 │
     │                 │────────────────►│                 │                 │
     │                 │                 │                 │                 │
     │                 │ 7. 편집 (자동저장)                 │                 │
     │                 │◄────────────────│                 │                 │
     │                 │─────────────────┼─────────────────┼────────────────►│
     │                 │                 │                 │                 │
     │                 │ 8. 편집 완료    │                 │                 │
     │                 │◄────────────────│                 │                 │
     │◄────────────────┼─────────────────│ onComplete      │                 │
     │                 │                 │                 │                 │
     │ 9. PDF 업로드 (표지/내지)         │                 │                 │
     │────────────────►│                 │                 │                 │
     │◄────────────────│ fileId          │                 │                 │
     │                 │                 │                 │                 │
     │ 10. 검증 요청   │                 │                 │                 │
     │────────────────►│                 │                 │                 │
     │                 │─────────────────┼────────────────►│                 │
     │                 │                 │                 │────────────────►│
     │                 │                 │                 │                 │
     │ 11. 결과 폴링   │                 │                 │                 │
     │────────────────►│                 │                 │                 │
     │◄────────────────│ 검증 결과       │                 │                 │
     │                 │                 │                 │                 │
     │ 12. 주문 완료/결제                │                 │                 │
     │─────────────────┼─────────────────┼─────────────────┼────────────────►│
     │                 │                 │                 │                 │
```

### 4.3 관리자 템플릿 편집 흐름

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│  관리자   │      │  에디터   │      │   API    │      │   DB     │
│ (React)  │      │(Standalone)     │ (NestJS) │      │(MariaDB) │
└────┬─────┘      └────┬─────┘      └────┬─────┘      └────┬─────┘
     │                 │                 │                 │
     │ 1. 관리자 로그인│                 │                 │
     │─────────────────┼────────────────►│                 │
     │◄────────────────┼─────────────────│ JWT             │
     │                 │                 │                 │
     │ 2. 템플릿 목록 조회               │                 │
     │─────────────────┼────────────────►│                 │
     │◄────────────────┼─────────────────│                 │
     │                 │                 │                 │
     │ 3. 템플릿 편집 클릭               │                 │
     │────────────────►│                 │                 │
     │                 │                 │                 │
     │                 │ 4. 템플릿 로드  │                 │
     │                 │────────────────►│                 │
     │                 │◄────────────────│                 │
     │                 │                 │                 │
     │                 │ 5. 캔버스 편집  │                 │
     │                 │                 │                 │
     │                 │ 6. 저장         │                 │
     │                 │────────────────►│                 │
     │                 │                 │────────────────►│
     │                 │◄────────────────│                 │
     │                 │                 │                 │
     │◄────────────────│ 7. 완료 (닫기)  │                 │
     │                 │                 │                 │
```

---

## 5. 데이터베이스 관계

### 5.1 현재 구조 (분리)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Storige DB                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐               │
│  │   users     │     │  templates  │     │template_sets│               │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤               │
│  │ id (PK)     │     │ id (PK)     │     │ id (PK)     │               │
│  │ email       │     │ name        │     │ name        │               │
│  │ password    │     │ canvas_data │     │ category_id │               │
│  │ role        │     │ template_set│────►│ size        │               │
│  │ (admin)     │     │             │     │ binding     │               │
│  └─────────────┘     └─────────────┘     └─────────────┘               │
│                                                                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐               │
│  │edit_sessions│     │ worker_jobs │     │   files     │               │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤               │
│  │ id (PK)     │     │ id (PK)     │     │ id (PK)     │               │
│  │ member_id ──┼──┐  │ type        │     │ file_name   │               │
│  │ order_id    │  │  │ status      │     │ file_path   │               │
│  │ canvas_data │  │  │ file_id ────┼────►│ mime_type   │               │
│  │ status      │  │  │ result      │     │ member_id   │               │
│  └─────────────┘  │  └─────────────┘     └─────────────┘               │
│                   │                                                     │
│                   │  (회원 ID 참조 - 향후 쇼핑몰 DB 통합)               │
│                   │                                                     │
└───────────────────┼─────────────────────────────────────────────────────┘
                    │
                    │  향후 통합
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        쇼핑몰 DB (gprinting)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐               │
│  │   member    │     │order_common │     │order_detail │               │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤               │
│  │ member_seqno│◄────│ member_seqno│     │ order_seqno │               │
│  │ id (mail)   │     │ order_num   │────►│ prdt_name   │               │
│  │ password    │     │ ord_state   │     │ amt         │               │
│  │ name        │     │ barcode_num │     │ price       │               │
│  │ phone       │     │ depo_finish │     │ file_seqno  │               │
│  └─────────────┘     └─────────────┘     └─────────────┘               │
│                                                                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐               │
│  │ order_file  │     │  products   │     │   payment   │               │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤               │
│  │ file_seqno  │     │ prdt_seqno  │     │ pay_seqno   │               │
│  │ file_path   │     │ cate_code   │     │ order_num   │               │
│  │ file_name   │     │ prdt_name   │     │ pay_type    │               │
│  │ origin_name │     │ sell_site   │     │ pay_amount  │               │
│  └─────────────┘     └─────────────┘     └─────────────┘               │
│                                                                         │
│  주문 상태 코드 (ord_state):                                            │
│  110-120: 주문, 210: 입금, 310-340: 접수, 410-430: 조판               │
│  510-530: 종이발주, 605-630: 출력, 705-730: 인쇄, 805-830: 후공정      │
│  910-920: 입고, 950-960: 출고, 010-011: 배송, 020-021: 구매확정        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 향후 통합 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      통합 DB (같은 MariaDB)                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐                                                        │
│  │   member    │  ← 쇼핑몰 회원 테이블을 Primary로 사용                  │
│  ├─────────────┤                                                        │
│  │member_seqno │────────────────────────────────────────┐               │
│  │ id (mail)   │                                        │               │
│  │ password    │                                        │               │
│  │ name        │                                        │               │
│  │ phone       │                                        │               │
│  │ storige_role│  ← 추가 (customer | admin)             │               │
│  └─────────────┘                                        │               │
│        │                                                │               │
│        │                                                │               │
│        ▼                                                ▼               │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐               │
│  │order_common │     │edit_sessions│     │   files     │               │
│  ├─────────────┤     ├─────────────┤     ├─────────────┤               │
│  │ order_num   │     │ id (PK)     │     │ id (PK)     │               │
│  │member_seqno │     │member_seqno │     │member_seqno │               │
│  │ ord_state   │     │ order_num───┼────►│ file_name   │               │
│  │ file_seqno  │     │ canvas_data │     │ file_path   │               │
│  └─────────────┘     └─────────────┘     └─────────────┘               │
│                                                                         │
│  JWT Payload:                                                           │
│  {                                                                      │
│    "sub": "member_seqno",                                               │
│    "source": "shop",     // shop | admin                                │
│    "role": "customer"    // customer | admin                            │
│  }                                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 배포 구성

### 6.1 서버 구성 (같은 서버)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     서버 (bookmoa.noriter.co.kr)                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Nginx (Reverse Proxy)                     │   │
│  │                            :80, :443                             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │                                                                  │   │
│  │  /              → PHP-FPM (쇼핑몰)                               │   │
│  │  /api/          → localhost:4000 (Storige API)                  │   │
│  │  /editor/       → localhost:3000 (에디터 Standalone)             │   │
│  │  /admin/        → localhost:3001 (관리자)                        │   │
│  │  /storage/      → /app/storage (정적 파일)                       │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │   PHP-FPM    │  │  Node.js     │  │  Node.js     │                  │
│  │   (쇼핑몰)    │  │  (API)       │  │  (Worker)    │                  │
│  │              │  │  :4000       │  │  :4001       │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  MariaDB     │  │    Redis     │  │   Storage    │                  │
│  │  :3306       │  │   :6379      │  │  /app/storage│                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 PM2 프로세스 관리

```javascript
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'storige-api',
      script: 'dist/main.js',
      cwd: '/app/storige/apps/api',
      env: {
        PORT: 4000,
        NODE_ENV: 'production'
      }
    },
    {
      name: 'storige-worker',
      script: 'dist/main.js',
      cwd: '/app/storige/apps/worker',
      env: {
        PORT: 4001,
        NODE_ENV: 'production'
      }
    },
    {
      name: 'storige-editor',
      script: 'serve',
      args: '-s dist -l 3000',
      cwd: '/app/storige/apps/editor'
    },
    {
      name: 'storige-admin',
      script: 'serve',
      args: '-s dist -l 3001',
      cwd: '/app/storige/apps/admin'
    }
  ]
};
```

---

## 7. 보안 고려사항

### 7.1 인증 토큰 보안

| 토큰 유형 | 저장 위치 | 보안 설정 |
|----------|----------|----------|
| 쇼핑몰 API Key | 서버 환경변수 | IP 화이트리스트 |
| 고객 Access Token | httpOnly Cookie | Secure, SameSite=Lax |
| 고객 Refresh Token | httpOnly Cookie | Secure, SameSite=Lax, Path=/api/auth |
| 관리자 JWT | localStorage | Bearer Token |

### 7.2 CORS 설정

```typescript
// API CORS 설정
app.enableCors({
  origin: [
    'http://bookmoa.noriter.co.kr',
    'http://bookmoa.noriter.co.kr:3000',
    'http://bookmoa.noriter.co.kr:3001'
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH']
});
```

### 7.3 파일 업로드 보안

- 허용 MIME 타입: `application/pdf`
- 최대 파일 크기: 100MB
- 파일명: UUID로 변환 (원본명 숨김)
- 접근: API를 통해서만 (직접 URL 접근 불가)

---

## 8. 모니터링 및 로깅

### 8.1 로그 구조

```
/var/log/storige/
├── api/
│   ├── access.log      # HTTP 요청 로그
│   ├── error.log       # 에러 로그
│   └── audit.log       # 인증/권한 로그
├── worker/
│   ├── jobs.log        # 작업 처리 로그
│   └── error.log       # 에러 로그
└── nginx/
    ├── access.log
    └── error.log
```

### 8.2 헬스체크 엔드포인트

```
GET /health           # API 상태
GET /health/db        # DB 연결 상태
GET /health/redis     # Redis 연결 상태
GET /health/worker    # Worker 상태
```

---

## 9. 향후 계획

### 9.1 Phase 1: 현재 (분리 운영)

- [x] 쇼핑몰 DB와 Storige DB 분리
- [x] member_id로 상호 참조
- [x] API Key + httpOnly Cookie 인증

### 9.2 Phase 2: DB 통합

- [ ] 같은 MariaDB 인스턴스 사용
- [ ] members 테이블에 storige_role 컬럼 추가
- [ ] JWT source 필드로 사용자 구분

### 9.3 Phase 3: 고도화

- [ ] S3 파일 스토리지 마이그레이션
- [ ] CDN 적용 (에디터 번들, 정적 에셋)
- [ ] WebSocket 실시간 협업 (선택)

---

## 10. 참고 자료

- [Worker UX 기획안](./worker-ux-plan.md)
- [PHP 에디터 연동 계획](./PHP_EDITOR_INTEGRATION_PLAN.md)
- [API 명세](./API_SPEC.md) (작성 예정)

---

## 부록 A. 북모아 주요 파일 경로

| 용도 | 파일 경로 |
|------|----------|
| 세션 초기화 | `front/common/sess_common.php` |
| DB 연결 | `inc/com/nexmotion/common/util/ConnectionPool.inc` |
| 요청/세션 처리 | `inc/com/nexmotion/common/entity/FormBean.inc` |
| 주문 상태 관리 | `inc/classes/dprinting/StateManager/` |
| 가격 계산 | `inc/classes/dprinting/PriceCalculator/` |
| 가격 유틸 | `inc/common_lib/CalcPriceUtil.inc` |
| 주문 상태 코드 | `inc/common_define/order_status.inc` |
| PDF 조판 엔진 | `nimda/cypress/process/` |
| Ghostscript | `nimda/cypress/ghostscript-9.22-linux-x86_64/` |

## 부록 B. 환경변수

| 변수 | 설명 | 예시 |
|------|------|------|
| `$_SERVER["INC"]` | inc 디렉토리 경로 | `/var/www/html/inc` |
| `$_SERVER["SELL_SITE"]` | 사이트 구분 코드 | `GP`, `DP` |
| `$_SERVER["SiteHome"]` | 사이트 홈 URL | `http://bookmoa.noriter.co.kr` |
| `$_SERVER["DOCUMENT_ROOT"]` | 웹 루트 | `/var/www/html/front` |
