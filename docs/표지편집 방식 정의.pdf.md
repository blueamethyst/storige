# Storige 사양 변경 영향도 분석 보고서

**작성일**: 2026년 2월 5일
**마감일**: 2026년 2월 14일
**분석자**: Senior Service Planner
**개발 방식**: Claude Code를 통한 AI 페어 프로그래밍
**가용 시간**: 하루 4시간 (21:00 ~ 01:00)

---

## 요약 (Executive Summary)

| 항목 | 예상 소요 | 실현 가능성 | 상태 | 비고 |
|------|-----------|------------|------|------|
| 1. 인쇄 PDF 분리 | 1.5일 | ~~90%~~ **100%** | ✅ **완료** | 2/5 구현 완료 |
| 2. 스프레드 편집 (표지+동적책등) | 5일 | 70% (중상) | 🔜 대기 | 표지 캔버스 + 내지 분리 |
| 3. 명함 상품 (PDF만) | 2일 | 85% (높음) | 🔜 대기 | AI 파일 기술적 불가 |

**결론** (Claude Code + 하루 4시간 기준):
- **총 예상 소요**: 6.5일 (AI 효율 반영)
- **현재 진행**: 1.5일 완료 / 5일 남음
- **마감까지**: 9일 (3.5일 버퍼 확보)
- **판정**: ✅ **마감 준수 가능**

**✅ PDF 분리 출력 구현 완료** (2/5):
- Storige Worker/API 코드 구현 완료
- 테스트 263개 모두 통과 (Worker 158 + API 65 + E2E 40)
- 북모아 웹훅 수신부 수정만 남음

**⚠️ 핵심 리스크** (리뷰 반영):
- ~~기능 난이도보다 **하위호환/연동 스펙 변경의 파급**이 더 큰 리스크~~ → ✅ 해결
- ~~PDF 분리는 Worker 내부에서 끝나지 않고 API 응답/웹훅/북모아 저장 로직까지 연쇄됨~~ → ✅ 하위호환 설계로 해결

---

## 1. 인쇄 PDF 분리 (표지/내지 별도 PDF 출력)

### 1.1 현재 상태
- **현행**: 표지 + 내지가 하나의 PDF로 병합되어 출력
- **변경 요청**: 표지와 내지를 별도 PDF 파일로 분리 출력

### 1.2 영향 받는 파일

```
apps/worker/src/
├── services/pdf-synthesizer.service.ts    # 핵심 수정 대상
├── processors/synthesis.processor.ts      # 출력 로직 수정
└── dto/synthesis-job.dto.ts              # DTO 확장

apps/api/src/worker-jobs/
├── worker-jobs.service.ts                 # 작업 생성 로직
└── dto/create-worker-job.dto.ts          # 출력 옵션 추가

packages/types/src/
└── worker-job.ts                         # 타입 정의 확장
```

### 1.3 구현 방안

**현재 코드에서 활용 가능한 부분:**
- `pdf-synthesizer.service.ts`에 이미 `extractPages()` 함수 존재
- PDF 페이지 분리 로직 기구현 상태

**수정 사항:**
1. `SynthesisJob`에 `separateOutput: boolean` 옵션 추가 (기본값: `false`)
2. `synthesizePdf()` 메서드에서 조건부 분리 출력 로직 추가
3. 출력 파일명 규칙: `{jobId}_cover.pdf`, `{jobId}_content.pdf` (세션 재시도 대비)
4. API 응답/웹훅에 분리된 파일 정보 배열 반환

### 1.4 DB 모델/파일 엔티티 반영 (보완)

**ERD 기준**: `files.file_type`이 `cover|content|template|other`로 구분됨

```typescript
// 분리 출력 결과를 files 테이블에 등록
// worker_jobs.result에 매핑 (추적/권한/다운로드 URL 일관성)
interface OutputFile {
  type: 'cover' | 'content';
  fileId: string;
  url: string;
}
```

### 1.5 API/웹훅 계약 변경 (하위호환) ✅ 구현 완료

**기존**: `outputFileUrl` 단일 필드
**변경**: 하위호환 유지 + 확장

```typescript
// outputFormat='merged' (기존 방식, 기본값)
{
  outputFileUrl: "/storage/outputs/{jobId}/merged.pdf"
}

// outputFormat='separate' (신규)
{
  outputFileUrl: "/storage/outputs/{jobId}/merged.pdf",  // 하위호환 유지 (항상 merged)
  outputFiles: [
    { type: "cover", url: "/storage/outputs/{jobId}/cover.pdf" },
    { type: "content", url: "/storage/outputs/{jobId}/content.pdf" }
  ],
  outputFormat: "separate"
}
```

### 1.6 서비스 플로우 ✅ 구현 완료

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            북모아 (PHP)                                      │
└─────────────────────────────────────────────────────────────────────────────┘
      │                                                           ▲
      │ 1. 병합 요청                                              │ 5. 웹훅 수신
      │    POST /api/worker-jobs/synthesize/external              │
      │    {                                                      │
      │      coverUrl: "...",                                     │
      │      contentUrl: "...",                                   │
      │      spineWidth: 5.5,                                     │
      │      outputFormat: "separate",  ← 신규 옵션               │
      │      callbackUrl: "https://bookmoa.com/webhook"           │
      │    }                                                      │
      ▼                                                           │
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Storige API                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ worker-jobs.service.ts                                              │    │
│  │  - createSynthesisJob()                                             │    │
│  │  - options.outputFormat 저장                                        │    │
│  │  - Bull Queue에 job 추가                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
      │                                                           ▲
      │ 2. Queue Job                                              │ 4. 상태 업데이트
      ▼                                                           │    PATCH /status
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Storige Worker                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ synthesis.processor.ts                                              │    │
│  │                                                                     │    │
│  │  3-1. PDF 생성 (synthesizeToLocal)                                  │    │
│  │       - merged.pdf 항상 생성                                        │    │
│  │       - separate 모드면 cover.pdf, content.pdf 추가 생성            │    │
│  │                                                                     │    │
│  │  3-2. 스토리지 저장                                                 │    │
│  │       outputs/{jobId}/merged.pdf                                    │    │
│  │       outputs/{jobId}/cover.pdf    (separate만)                     │    │
│  │       outputs/{jobId}/content.pdf  (separate만)                     │    │
│  │                                                                     │    │
│  │  3-3. 임시 파일 정리                                                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 웹훅 응답 비교

| 모드 | outputFileUrl | outputFiles | 사용 시나리오 |
|------|---------------|-------------|--------------|
| `merged` (기본) | merged.pdf URL | 없음 | 기존 클라이언트 |
| `separate` | merged.pdf URL ✅ | cover + content | 인쇄소 별도 전달 |

**핵심**: `outputFormat: "separate"` 옵션만 추가하면 분리 출력 활성화, 기존 코드는 `outputFileUrl`만 사용하므로 **하위호환 완벽 유지**

#### 북모아 연동 코드 예시 (PHP)

```php
<?php
// 웹훅 수신 핸들러
$payload = json_decode(file_get_contents('php://input'), true);

if ($payload['event'] === 'synthesis.completed') {
    $orderId = $payload['orderId'];

    // 하위호환: 기존 코드 그대로 동작
    $mergedUrl = $payload['outputFileUrl'];
    saveMergedPdf($orderId, $mergedUrl);

    // 신규: separate 모드 처리 (옵션)
    if (isset($payload['outputFiles']) && is_array($payload['outputFiles'])) {
        foreach ($payload['outputFiles'] as $file) {
            if ($file['type'] === 'cover') {
                saveCoverPdf($orderId, $file['url']);
            } elseif ($file['type'] === 'content') {
                saveContentPdf($orderId, $file['url']);
            }
        }
    }
}
?>
```

### 1.7 구현 완료 파일 목록 ✅

| 파일 | 변경 내용 |
|------|----------|
| `packages/types/src/index.ts` | `SynthesisOptions`, `SynthesisLocalResult`, `OutputFile`, `SynthesisWebhookPayload` 타입 추가 |
| `apps/worker/src/services/pdf-synthesizer.service.ts` | `synthesizeToLocal()` 메서드 추가 (로컬 파일 경로 반환) |
| `apps/worker/src/processors/synthesis.processor.ts` | separate 모드 처리, 스토리지 저장, cleanup 로직 |
| `apps/api/src/worker-jobs/dto/worker-job.dto.ts` | `outputFormat`, `outputFiles` 필드 추가 |
| `apps/api/src/worker-jobs/worker-jobs.service.ts` | 웹훅 페이로드에 `outputFiles`, `outputFormat` 포함 |
| `apps/api/src/webhook/webhook.service.ts` | `@storige/types`의 `SynthesisWebhookPayload` 사용 |

### 1.8 테스트 결과 ✅

| 테스트 종류 | 테스트 수 | 결과 |
|------------|----------|------|
| Worker 유닛/통합 테스트 | 158개 | ✅ 모두 통과 |
| API 유닛 테스트 | 65개 | ✅ 모두 통과 |
| API E2E 테스트 (worker-jobs) | 40개 | ✅ 모두 통과 |

**PDF 분리 출력 관련 테스트 케이스:**
- TC-SEP-001: 기본 모드 (merged) - outputFormat 미지정 시 merged로 저장 ✅
- TC-SEP-002: 분리 모드 (separate) - outputFormat: separate 요청 ✅
- TC-SEP-003: 분리 모드 완료 시 outputFiles 포함 응답 ✅
- TC-SEP-004: 하위호환 - merged 모드에서는 outputFiles 없음 ✅
- TC-SEP-005: 분리 모드 실패 시 outputFileUrl 빈값, errorMessage 포함 ✅
- TC-SEP-006: outputFiles 순서 검증 (cover → content) ✅
- TC-SEP-007: queueJobId 디버깅 필드 전달 ✅
- TC-RETRY-001: 동일 jobId로 상태 업데이트 재시도 (idempotency) ✅

### 1.9 실제 소요 시간 ✅

| 단계 | 예상 | 실제 | 비고 |
|------|------|------|------|
| 타입 정의 | 0.5시간 | 0.5시간 | ✅ |
| Worker 서비스 | 1.5시간 | 1.5시간 | ✅ |
| Worker 프로세서 | 1시간 | 1시간 | ✅ |
| API DTO/서비스 | 1시간 | 1시간 | ✅ |
| 테스트 작성 | 1시간 | 1시간 | ✅ |
| **총계** | **5시간** | **5시간** | **1.5일 (4시간/일 기준)** |

### 1.10 남은 작업

| 작업 | 담당 | 상태 |
|------|------|------|
| 북모아 웹훅 수신부 수정 | 북모아 개발 | 🔜 대기 |
| E2E 검증 (실제 환경) | QA | 🔜 대기 |

### 1.11 리스크
- ~~**중간**: API 응답/웹훅 payload 확장은 북모아 수신부 변경 필수~~ → ✅ 해결 (하위호환 설계)
- 기존 병합 출력 기능 유지 가능 (하위 호환성) ✅

### 1.12 실현 가능성: **100% (구현 완료)**

---

## 2. 에디터 스프레드 편집 (표지+날개+책등 동시 편집)

### 2.1 현재 상태
- **현행**: 개별 페이지 단위 편집 (표지, 날개, 책등 각각 별도 Canvas)
- **변경 요청**: 스프레드 뷰에서 표지+날개+책등을 한 화면에서 동시 편집

### 2.2 전체 책 구조 분석

**물리적 책 구조**:
```
뒷날개 - 뒷표지 - 책등 - [내지들] - 앞표지 - 앞날개
```

내지는 표지 "안쪽"에 위치하며, 내지 페이지 수에 따라 책등 크기가 동적으로 변경됨.

### 2.3 구현 방안: 표지 스프레드 캔버스 + 내지 개별 캔버스 (권장)

```typescript
// 캔버스 구성
Canvas0: [뒷날개] [뒷표지] [책등] [앞표지] [앞날개]  // 표지 스프레드 (논리적 5영역)
Canvas1: 내지 페이지1
Canvas2: 내지 페이지2
...

// 표지 스프레드 내 좌표 구조
interface CoverSpreadCoordinates {
  backWing: { left: number, width: number }     // 뒷날개 (60mm)
  backCover: { left: number, width: number }    // 뒷표지 (91mm)
  spine: { left: number, width: number }        // 책등 (동적)
  frontCover: { left: number, width: number }   // 앞표지 (91mm)
  frontWing: { left: number, width: number }    // 앞날개 (60mm)
}
```

### 2.4 동적 책등 크기 계산

**현재 구현 (apps/api/src/products/spine.service.ts)**:
```
책등 너비 = (페이지 수 / 2) × 용지 두께(mm) + 제본 여유분(mm)

예: 100페이지, 0.1mm 용지, 2mm 제본여유 → (100/2) × 0.1 + 2 = 7mm
```

**자동 재계산 트리거 필요**:
- 현재: `recalculateSpineWidth()` 수동 호출
- 변경: 내지 추가/삭제 시 자동 재계산

```typescript
// useAppStore.ts의 addPage()/deletePage()에 추가
async deletePage(canvasId: string) {
  // ... 기존 로직 ...
  await recalculateSpineWidth()  // 자동 재계산
}
```

### 2.5 기술적 장점

1. **기존 아키텍처 호환성**
   - `allCanvas`, `allEditors` 배열 구조 유지
   - 페이지 탭 UX 유지 가능

2. **활용 가능한 기존 코드**
   - `WorkspacePlugin`: clipPath, 경계선 렌더링 (line 730-995)
   - `spineCalculator.ts`: `recalculateSpineWidth()` 함수
   - Spine 계산 API: `POST /products/spine/calculate`

3. **최소 변경 범위**
   - 표지 좌표 계산 로직만 추가
   - 내지 추가/삭제 시 자동 재계산 트리거 추가

### 2.6 영향 받는 파일

```
apps/editor/src/
├── utils/coverSpreadCalculator.ts     # 신규: 표지 좌표 계산
├── utils/spineCalculator.ts           # 수정: 객체 위치 재계산 추가
├── stores/useAppStore.ts              # 수정: 자동 재계산 트리거
└── components/Canvas/CanvasContainer.tsx  # UI 조정

packages/canvas-core/src/
├── plugins/WorkspacePlugin.ts         # 스프레드 모드 추가
│   ├── calculateCoverSpreadCoordinates()  # 신규: 5영역 좌표
│   └── drawSpreadGuideLines()         # 신규: 영역 경계선
└── models/CanvasSettings.ts           # spreadType 필드 추가
```

### 2.7 구현 단계

| 단계 | 작업 내용 | 소요 |
|------|----------|------|
| 1 | 표지 좌표 계산 로직 (`coverSpreadCalculator.ts`) | 0.5일 |
| 2 | WorkspacePlugin 스프레드 모드 추가 | 1일 |
| 3 | 영역별 경계선/가이드라인 렌더링 | 0.5일 |
| 4 | 자동 책등 재계산 트리거 (내지 추가/삭제) | 0.5일 |
| 5 | 인접 객체 위치 재계산 로직 | 1일 |
| 6 | 저장/로드 시 영역별 분리 처리 | 0.5일 |
| 7 | 테스트 및 버그 수정 | 1일 |
| **총계** | | **5일** |

### 2.8 객체 리레이아웃 정책 (보완 - 필수 결정 사항)

**정책 A** (권장): 영역(local) 좌표 방식
- 오브젝트는 자신의 '영역' 기준 좌표를 가짐
- spineWidth 변경 시 영역 origin만 이동
- 객체 상대 위치 자동 보존

**정책 B**: 전역 좌표 + delta shift
- spine 구간 변동 시 spine 오른쪽 구간만 deltaX만큼 이동
- frontCover/frontWing 전체 shift

```typescript
// 정책 A 구현 예시
interface ObjectWithRegion {
  regionName: 'backWing' | 'backCover' | 'spine' | 'frontCover' | 'frontWing';
  localLeft: number;  // 영역 기준 상대 좌표
  localTop: number;
}
```

### 2.9 저장/로드 역직렬화 호환 (보완)

**문제**: 기존 데이터와 스프레드 모드 구분 필요

```typescript
// 스프레드 모드 판별 마커 추가
interface CanvasData {
  metadata: {
    coverSpread?: boolean;  // 스프레드 모드 여부
    spineWidth?: number;    // 저장 시점 책등 너비
    regions?: SpreadRegion[];
  };
  objects: fabric.Object[];
}
```

**레거시 템플릿 처리**:
- `metadata.coverSpread` 없으면 단일 페이지 모드로 로드
- 마이그레이션 필요 시 기본값 적용

### 2.10 WorkspacePlugin 변경 범위 제한 (1차 버전)

**1차 버전 (마감일 내)**:
- ✅ 가이드라인: purely visual
- ✅ 영역 clipPath: 전체 스프레드 workspace에만 clip
- ❌ 영역별 개별 clip: 2차로 미룸

### 2.11 리스크
- **중간**: 기존 `allCanvas` 구조 유지로 리스크 감소
- **주의**: 정책 미결정 시 버그 수정 1일 초과 가능성

### 2.12 실현 가능성: **70% (중상)**

**핵심 근거**:
- 기존 `recalculateSpineWidth()` 함수 활용 가능
- Spine 계산 API 이미 구현 완료
- `allCanvas`, `allEditors` 구조 변경 불필요

---

## 3. 명함 상품 추가 (파일 업로드 검증)

### 3.1 현재 상태
- **현행**: 에디터 기반 상품만 지원 (템플릿 → 편집 → 주문)
- **변경 요청**: 파일 업로드 → 검증 → 주문 플로우 (에디터 없음)

### 3.2 요구사항 분석

```
[사용자 플로우]
1. 명함 상품 선택
2. PDF 또는 AI 파일 업로드
3. 자동 검증 (규격, 해상도, 여백 등)
4. 검증 결과 표시
5. 주문 진행
```

### 3.3 영향 받는 파일

```
apps/api/src/
├── products/
│   ├── entities/product.entity.ts     # productType 추가
│   └── dto/                           # 명함용 DTO
├── upload/                            # 신규 모듈
│   ├── upload.module.ts
│   ├── upload.controller.ts
│   ├── upload.service.ts
│   └── validators/
│       ├── pdf.validator.ts           # PDF 검증 로직
│       └── ai.validator.ts            # AI 파일 검증 (미구현)
└── orders/
    └── orders.service.ts              # 업로드 기반 주문 처리

apps/worker/src/
├── processors/
│   └── validation.processor.ts        # 검증 작업 처리
└── services/
    └── file-validator.service.ts      # 파일 검증 서비스
```

### 3.4 핵심 기술적 과제

1. **PDF 검증** (구현 가능)
   - 해상도 확인: pdf-lib + Sharp 조합
   - 페이지 크기 확인: pdf-lib
   - 여백/재단선 검증: 커스텀 로직

2. **AI 파일 검증** (구현 불가)
   - Adobe Illustrator 포맷 (.ai)
   - Node.js 네이티브 파서 **존재하지 않음**
   - Ghostscript: PDF 호환 AI만 제한적 처리 (최신 AI 포맷 불가)
   - 외부 서비스: Adobe API 등 유료 서비스 필요 + 별도 일정
   - **결론: AI 검증은 현재 범위에서 제외** (추후 별도 프로젝트로)

### 3.5 예상 소요 시간

| 작업 | PDF만 | PDF + AI |
|------|-------|----------|
| 업로드 모듈 | 0.5일 | 0.5일 |
| PDF 검증 로직 | 1일 | 1일 |
| AI 검증 로직 | - | 2일+ |
| 주문 플로우 연동 | 0.5일 | 0.5일 |
| 프론트엔드 UI | 0.5일 | 0.5일 |
| 테스트 | 0.5일 | 1일 |
| **총계** | **3일** | **5일+** |

### 3.6 리스크
- **중간**: 새로운 상품 유형이지만 기존 아키텍처 활용 가능
- AI 파일 검증은 기술적 불확실성 높음

### 3.7 세션 모델 선택 (보완)

**ERD 기준**: `file_edit_sessions`가 cover/content 파일을 FK로 보유, `mode`도 존재

**권장**: `file_edit_sessions` 재사용
- `mode=upload` 신규 추가 (또는 `mode=template` 활용)
- worker_jobs와의 연결 깨끗하게 유지

```typescript
// file_edit_sessions 확장
{
  mode: 'upload',  // 에디터 없이 업로드만
  uploadedFileId: 'xxx',
  validationResult: {...}
}
```

### 3.8 업로드 모듈과 기존 FilesModule 중복 방지

**주의**: API에 `files/*` 모듈 이미 존재

```
upload 모듈 (신규)
├── 업로드 수신
├── 검증 요청 생성
└── 검증 결과 반환

files 모듈 (기존) ← 저장소/권한/URL발급 귀결
```

### 3.9 검증 결과 스키마 (보완)

```typescript
interface ValidationResult {
  isValid: boolean;
  errors: ValidationError[];    // 치명적 오류 (주문 불가)
  warnings: ValidationWarning[]; // 경고 (주문 가능)
  details: {
    pageSize: { width: number, height: number };  // mm
    bleedDetected: boolean;
    dpiEstimated: number;
    safeMarginOk: boolean;
  };
}
```

### 3.10 실현 가능성

- PDF 검증만: **85% (높음)**
- AI 검증: **불가** (기술적 제약)

**결론:**
- 명함 상품은 **PDF 파일만 지원**
- AI 파일은 "PDF로 변환하여 업로드" 안내로 대체
- 추후 AI 지원 필요시 Adobe API 등 유료 서비스 연동 검토

---

## 4. 하위호환 전략 (필수)

### 4.1 PDF 분리 출력
- `separateOutput` 기본값: `false` (기존 동작 유지)
- 웹훅/응답: 기존 `outputFileUrl` 유지 + `outputFiles` 배열 추가
- 북모아 분기 처리: 버전 필드 또는 feature flag

### 4.2 스프레드 편집
- 레거시 템플릿: `metadata.coverSpread` 없으면 단일 페이지 모드
- 새 템플릿만 스프레드 모드 지원

---

## 5. 테스트 범위 (최소 세트)

### 5.1 PDF 분리
- [ ] 표지 1p / 내지 Np 케이스
- [ ] 재시도(Attempts=3)에서 파일 중복 생성/덮어쓰기 안전성
- [ ] 웹훅 payload 하위호환 확인

### 5.2 스프레드
- [ ] page add/delete 반복 시 spineWidth 변동 + 오브젝트 위치 보존
- [ ] 레거시 템플릿 로드 (스프레드 정보 없는 케이스)
- [ ] 영역 경계선 렌더링 정확도

### 5.3 명함 업로드
- [ ] 잘못된 page size
- [ ] 다중 페이지 PDF
- [ ] 여백 부족 케이스

---

## 6. 북모아 연동 변경 목록

| 변경 항목 | Storige 변경 | 북모아(PHP) 변경 |
|----------|-------------|-----------------|
| synthesize 완료 웹훅 | `outputFiles` 배열 추가 | 웹훅 수신 파싱 수정 |
| 주문 파일 저장 | cover/content 분리 저장 | 2개 파일 받도록 수정 |
| 다운로드 링크 | 2개 URL 제공 | 마이페이지/관리자 링크 2개 노출 |

---

## 일정 조정 권장안

### 개발 가용 시간 분석
- **일일 가용 시간**: 4시간 (21:00 ~ 01:00)
- **마감까지 남은 일수**: 10일 (2/5 ~ 2/14, 주말 포함)
- **총 가용 시간**: 40시간
- **Claude Code 효율**: AI 페어 프로그래밍으로 **생산성 1.5~2배** 예상

### 작업량 재산정 (하루 4시간 기준)

| 항목 | 예상 공수 | Claude Code 보정 | 실제 소요 (일) |
|------|----------|-----------------|---------------|
| PDF 분리 출력 | 8시간 | × 0.6 = 5시간 | **1.5일** |
| 스프레드 편집 | 20시간 | × 0.7 = 14시간 | **3.5일** |
| 명함 상품 | 8시간 | × 0.6 = 5시간 | **1.5일** |
| **합계** | 36시간 | 24시간 | **6.5일** |

### Option A: 전체 항목 완료 ✅ 권장

| 날짜 | 항목 | 세부 작업 | 고정 슬롯 |
|------|------|----------|----------|
| 2/5 (목) | PDF 분리 | DTO 확장, 분리 옵션 구현 | |
| 2/6 (금) | PDF 분리 | 테스트, 배포 | ⚠️ **북모아 수신부 최소 수정 포함** |
| 2/7 (토) | 스프레드 | 좌표 계산 로직, WorkspacePlugin 수정 | |
| 2/8 (일) | 스프레드 | 경계선 렌더링, 영역 관리 | |
| 2/9 (월) | 스프레드 | 동적 책등 재계산 트리거 | |
| 2/10 (화) | 스프레드 | 저장/로드 로직 | ⚠️ **레거시 템플릿 마이그레이션 테스트** |
| 2/11 (수) | 명함 | 업로드 모듈, PDF 검증 | |
| 2/12 (목) | 명함 | 주문 연동, 테스트 | |
| 2/13 (금) | 리그레션 | | ⚠️ **통합 E2E 테스트 (주문 플로우)** |
| **2/14 (토)** | **마감** | 배포 | |

**총 소요: 8일** (2일 버퍼) → **마감 준수 가능**

### Option B: 안전 마진 확보 (스프레드 축소)

스프레드 편집을 "미리보기만" 구현 (편집 기능 제외):

| 항목 | 소요 |
|------|------|
| PDF 분리 | 1.5일 |
| 스프레드 미리보기 | 2일 |
| 명함 상품 | 1.5일 |
| **합계** | 5일 (5일 버퍼) |

---

## 7. 사전 작업 (개발 착수 전 필요)

### 7.1 PDF 분리 출력

#### 디자인/UI 작업
| 항목 | 설명 | 담당 | 기한 | 완료 |
|------|------|------|------|------|
| 북모아 다운로드 UI | 표지/내지 2개 파일 다운로드 버튼 배치 | | 2/5 | [ ] |
| 관리자 주문상세 UI | 2개 파일 목록 표시 방식 | | 2/5 | [ ] |

#### 확정 필요 사항
| 항목 | 옵션 | 결정 |
|------|------|------|
| 파일명 규칙 | `주문번호_표지.pdf` / `주문번호_내지.pdf` | [ ] |
| 분리 옵션 활성화 조건 | 상품별 / 전체 적용 | [ ] |

#### 테스트 파일 준비
- [ ] 표지 1p + 내지 10p 샘플
- [ ] 표지 1p + 내지 100p 샘플 (대용량)
- [ ] 표지만 있는 케이스

---

### 7.2 스프레드 편집

#### 디자인/UI 작업
| 항목 | 설명 | 담당 | 기한 | 완료 |
|------|------|------|------|------|
| 스프레드 뷰 레이아웃 | 전체 펼침 상태 화면 구성 | | 2/7 | [ ] |
| 영역 경계선 스타일 | 색상, 두께, 점선/실선 | | 2/7 | [ ] |
| 영역 라벨 | "뒷날개", "뒷표지", "책등" 등 표시 여부 | | 2/7 | [ ] |
| 책등 크기 변경 알림 | "책등이 Xmm로 변경됩니다" 토스트 | | 2/9 | [ ] |

#### 확정 필요 사항
| 항목 | 옵션 | 결정 |
|------|------|------|
| 날개 기본 크기 | 60mm / 50mm / 상품별 설정 | [ ] |
| 표지 기본 크기 | 91mm / 상품별 설정 | [ ] |
| 객체 위치 정책 | 정책A(영역 내 상대좌표) / 정책B(전체 이동) | [ ] |

#### 용지 두께 기준표 (책등 계산용)
| 용지 종류 | 두께 (mm) | 확정 |
|----------|----------|------|
| 아트지 100g | | [ ] |
| 아트지 150g | | [ ] |
| 모조지 80g | | [ ] |
| 모조지 100g | | [ ] |
| 스노우지 150g | | [ ] |

#### 테스트 파일 준비
- [ ] 기존 템플릿 (레거시, 스프레드 정보 없음)
- [ ] 다양한 내지 수 (10p, 50p, 100p, 200p)

---

### 7.3 명함 상품 (🔴 검증 조건 확정 필수)

#### 디자인/UI 작업
| 항목 | 설명 | 담당 | 기한 | 완료 |
|------|------|------|------|------|
| 파일 업로드 페이지 | 드래그앤드롭, 파일 선택 UI | | 2/11 | [ ] |
| 검증 결과 화면 | 성공/실패/경고 표시 방식 | | 2/11 | [ ] |
| 에러 메시지 디자인 | 각 검증 실패 시 표시 UI | | 2/11 | [ ] |
| PDF 미리보기 | 업로드된 파일 썸네일 | | 2/11 | [ ] |

#### 🔴 검증 조건 확정 (개발 전 필수)

**명함 규격**
| 항목 | 옵션 | 결정 |
|------|------|------|
| 기본 사이즈 | 90×50mm / 86×54mm / 기타 | [ ] |
| 재단선 (도련) | 3mm / 2mm / 없음 | [ ] |
| 안전 여백 | 3mm / 5mm | [ ] |
| 양면 지원 | 2페이지 필수 / 1페이지 허용 | [ ] |

**해상도/품질**
| 항목 | 옵션 | 결정 |
|------|------|------|
| 최소 해상도 | 300dpi (권장) / 150dpi (최소) | [ ] |
| 해상도 미달 시 | 에러 (주문불가) / 경고 (주문가능) | [ ] |

**색상**
| 항목 | 옵션 | 결정 |
|------|------|------|
| 색상 모드 | CMYK 필수 / RGB 허용 | [ ] |
| RGB 업로드 시 | 자동 변환 / 경고 표시 / 에러 | [ ] |

**파일 형식**
| 항목 | 옵션 | 결정 |
|------|------|------|
| 지원 포맷 | PDF만 | 확정 |
| 최대 파일 크기 | 10MB / 50MB / 100MB | [ ] |

#### 에러/경고 메시지 문구 (확정 필요)

**에러 (주문 불가)**
```
- "페이지 크기가 맞지 않습니다. (현재: {width}×{height}mm, 필요: 90×50mm)"
- "파일이 손상되었거나 읽을 수 없습니다."
- "페이지 수가 올바르지 않습니다. (현재: {n}페이지, 필요: 2페이지)"
```

**경고 (주문 가능)**
```
- "해상도가 낮습니다. ({dpi}dpi) 인쇄 품질이 저하될 수 있습니다."
- "재단선 여백이 부족합니다. 중요 내용이 잘릴 수 있습니다."
- "RGB 색상 모드입니다. 인쇄 시 색상 차이가 발생할 수 있습니다."
```

#### 테스트 파일 준비
- [ ] 정상 파일 (모든 조건 충족)
- [ ] 사이즈 오류 (규격 불일치)
- [ ] 저해상도 (72dpi, 150dpi)
- [ ] 여백 부족 (재단선 영역 침범)
- [ ] 1페이지만 (단면)
- [ ] 3페이지 이상 (다중 페이지)
- [ ] 대용량 (50MB 이상)
- [ ] 손상 파일 (읽기 불가)

---

### 7.4 사전 작업 일정 요약

| 담당 | 항목 | 기한 |
|------|------|------|
| **기획** | 명함 검증 조건 확정 | **2/5 (목)** |
| **기획** | 스프레드 객체 정책 결정 | 2/6 (금) |
| **기획** | 용지 두께 기준표 확정 | 2/6 (금) |
| **기획** | 에러 메시지 문구 작성 | 2/10 (화) |
| **디자인** | 북모아 다운로드 UI | 2/5 (목) |
| **디자인** | 스프레드 뷰 UI | 2/7 (토) |
| **디자인** | 명함 업로드 UI | 2/11 (수) |
| **QA** | 테스트 파일 준비 | 2/10 (화) |

---

## 최종 권장사항

### 스프레드 편집 구현 방안

**채택 방안**: 표지 스프레드 캔버스(논리적 5영역) + 내지 개별 캔버스 + 동적 책등 재계산

| 구성요소 | 설명 |
|---------|------|
| Canvas0 | 표지 스프레드: 뒷날개-뒷표지-책등-앞표지-앞날개 (단일 캔버스, 5영역) |
| Canvas1~N | 내지 페이지 (기존 방식 유지) |
| 책등 크기 | 내지 추가/삭제 시 자동 재계산 |

### 핵심 구현 작업

| 순서 | 항목 | 핵심 작업 |
|------|------|----------|
| 1 | PDF 분리 출력 | `pdf-synthesizer.service.ts`에 분리 옵션 추가 |
| 2 | 스프레드 편집 | 표지 좌표 계산 + 동적 책등 재계산 트리거 |
| 3 | 명함 상품 | 업로드 모듈 신규 생성, PDF 검증 로직 구현 |

### 주요 결정 사항
1. **스프레드 편집**:
   - 표지: 단일 캔버스 + 논리적 5영역 분할
   - 내지: 기존 개별 캔버스 방식 유지
   - 책등: `addPage()`/`deletePage()` 시 자동 재계산

2. **명함 상품**: PDF 파일만 지원
   - AI 파일: Node.js 파서 부재로 **기술적 불가**
   - 대안: "AI 파일은 PDF로 변환하여 업로드" 안내 문구 추가

### 일정 달성 방안
**Claude Code를 통한 AI 페어 프로그래밍** (하루 4시간)

- 총 예상 소요: 6.5일 (Claude Code 효율 반영)
- 마감까지: 10일 (2일 버퍼 포함)
- **결론**: 마감 준수 가능

### 일별 상세 계획

| 날짜 | 항목 | 목표 | 완료 기준 |
|------|------|------|----------|
| 2/5 (목) | PDF 분리 | DTO + 분리 로직 | Worker 분리 출력 동작 확인 |
| 2/6 (금) | PDF 분리 | 테스트 + **북모아 연동** | 웹훅 수신 → 2개 파일 저장 확인 |
| 2/7 (토) | 스프레드 | 좌표 계산 | CoverSpreadCoordinates 구현 |
| 2/8 (일) | 스프레드 | 경계선 렌더링 | 5영역 가이드라인 표시 |
| 2/9 (월) | 스프레드 | 책등 재계산 | addPage/deletePage 트리거 |
| 2/10 (화) | 스프레드 | 저장/로드 | **레거시 마이그레이션 테스트** |
| 2/11 (수) | 명함 | 업로드 + 검증 | ValidationResult 스키마 구현 |
| 2/12 (목) | 명함 | 주문 연동 | file_edit_sessions 연결 |
| 2/13 (금) | 리그레션 | **통합 E2E** | 전체 주문 플로우 테스트 |
| **2/14 (토)** | **마감** | 배포 | 프로덕션 배포 완료 |
